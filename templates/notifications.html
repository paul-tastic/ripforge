{% extends "base.html" %}

{% block title %}RipForge - Notifications{% endblock %}
{% block page_title %}Notifications{% endblock %}

{% block content %}
<div class="notifications-page">
    <!-- Email Provider Settings -->
    <section class="card">
        <h2>Email Provider</h2>
        <p class="card-description">Configure how RipForge sends emails</p>

        <div class="newsletter-settings">
            <div class="settings-row">
                <div class="field">
                    <label>Provider</label>
                    <select id="email-provider" onchange="toggleSendGridKey()">
                        <option value="sendgrid">SendGrid (Recommended)</option>
                        <option value="msmtp">System Mail (msmtp)</option>
                    </select>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        SendGrid offers 100 free emails/day with better Gmail deliverability
                    </small>
                </div>
            </div>

            <div id="sendgrid-config" style="display: none; margin-top: 16px;">
                <div class="field">
                    <label>SendGrid API Key</label>
                    <input type="password" id="sendgrid-api-key" placeholder="SG.xxxxxxxxxx...">
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Get your free API key at <a href="https://app.sendgrid.com/settings/api_keys" target="_blank" style="color: var(--accent);">sendgrid.com</a> (100 emails/day free)
                    </small>
                </div>
                <div class="field" style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="check-suppressions" checked>
                        <span>Check SendGrid opt-outs before sending</span>
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Automatically skip recipients who have unsubscribed, bounced, or reported spam
                    </small>
                </div>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveEmailProvider()">Save Provider</button>
                <button class="btn btn-secondary" onclick="testEmailProvider()">Test Email</button>
                <span class="email-test-status" id="email-provider-status"></span>
            </div>
        </div>
    </section>

    <!-- Email Branding -->
    <section class="card">
        <h2>Email Branding</h2>
        <p class="card-description">Customize how your weekly digest appears</p>

        <div class="newsletter-settings">
            <div class="field">
                <label>From Name</label>
                <input type="text" id="email-from-name" placeholder="Lakehouse Plex Media Server">
                <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                    This appears as the sender name (e.g., "Lakehouse Plex Media Server")
                </small>
            </div>
            <div class="field" style="margin-top: 16px;">
                <label>Subject Line</label>
                <input type="text" id="email-weekly-subject" placeholder="Weekly Digest - New Additions">
                <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                    The count will be appended automatically (e.g., "Weekly Digest - New Additions (5 titles)")
                </small>
            </div>
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveEmailBranding()">Save Branding</button>
                <span class="email-test-status" id="email-branding-status"></span>
            </div>
        </div>
    </section>

    <!-- Newsletter Settings -->
    <section class="card">
        <h2>Newsletter Settings</h2>
        <div class="newsletter-settings">
            <div class="settings-row">
                <div class="field">
                    <label>Frequency</label>
                    <select id="newsletter-frequency">
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Every 2 Weeks</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div class="field">
                    <label>Day</label>
                    <select id="newsletter-day">
                        <option value="sunday">Sunday</option>
                        <option value="monday">Monday</option>
                        <option value="tuesday">Tuesday</option>
                        <option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option>
                        <option value="friday">Friday</option>
                        <option value="saturday">Saturday</option>
                    </select>
                </div>
                <div class="field">
                    <label>Time</label>
                    <select id="newsletter-hour">
                        <option value="6">6:00 AM</option>
                        <option value="7">7:00 AM</option>
                        <option value="8">8:00 AM</option>
                        <option value="9">9:00 AM</option>
                        <option value="10">10:00 AM</option>
                        <option value="12">12:00 PM</option>
                        <option value="18">6:00 PM</option>
                    </select>
                </div>
            </div>
            <div class="field">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="margin-bottom: 0;">Recipients</label>
                    <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px;" onclick="syncSuppressions()" id="btn-sync-suppressions">
                        Sync Opt-outs
                    </button>
                </div>
                <div class="recipients-list" id="recipients-list" style="max-height: 200px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 8px; margin-bottom: 12px;">
                    <!-- Recipients will be loaded here -->
                </div>
                <div style="display: flex; gap: 8px;">
                    <input type="email" id="new-recipient" placeholder="Add email address" style="flex: 1;">
                    <button class="btn btn-secondary" onclick="addRecipient()">Add</button>
                </div>
            </div>
            <div class="settings-actions">
                <button class="btn btn-primary" id="btn-save-newsletter">Save Settings</button>
                <button class="btn btn-secondary" id="btn-send-test">Send Test Email</button>
                <small style="color: var(--text-muted); margin-left: 8px;">Test sends to first enabled recipient only</small>
            </div>
        </div>
    </section>

    <!-- Newsletter Preview -->
    <section class="card">
        <h2>Newsletter Preview</h2>
        <p class="card-description" id="newsletter-date-range">Loading date range...</p>

        <div class="queue-list" id="newsletter-preview" style="max-height: 300px; overflow-y: auto;">
            <div class="queue-empty">Loading...</div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadEmailProvider();
        loadEmailBranding();
        loadNewsletterSettings();
        loadQueue();
    });

    // Email Provider Functions
    function toggleSendGridKey() {
        const provider = document.getElementById('email-provider').value;
        document.getElementById('sendgrid-config').style.display =
            provider === 'sendgrid' ? 'block' : 'none';
    }

    function loadEmailProvider() {
        fetch('/api/settings')
            .then(r => r.json())
            .then(data => {
                const emailCfg = data.notifications?.email || {};
                document.getElementById('email-provider').value = emailCfg.provider || 'msmtp';
                document.getElementById('sendgrid-api-key').value = emailCfg.sendgrid_api_key || '';
                document.getElementById('check-suppressions').checked = emailCfg.check_suppressions !== false;
                toggleSendGridKey();
            });
    }

    function saveEmailProvider() {
        const provider = document.getElementById('email-provider').value;
        const apiKey = document.getElementById('sendgrid-api-key').value;
        const checkSuppressions = document.getElementById('check-suppressions').checked;

        fetch('/api/settings')
            .then(r => r.json())
            .then(currentSettings => {
                // Merge with existing settings
                if (!currentSettings.notifications) currentSettings.notifications = {};
                if (!currentSettings.notifications.email) currentSettings.notifications.email = {};

                currentSettings.notifications.email.provider = provider;
                if (provider === 'sendgrid') {
                    currentSettings.notifications.email.sendgrid_api_key = apiKey;
                    currentSettings.notifications.email.check_suppressions = checkSuppressions;
                }

                return fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentSettings)
                });
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showProviderStatus('Saved!', 'success');
                } else {
                    showProviderStatus('Save failed', 'error');
                }
            })
            .catch(err => {
                showProviderStatus('Error: ' + err, 'error');
            });
    }

    function testEmailProvider() {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Sending...';
        showProviderStatus('', '');

        fetch('/api/email/test', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showProviderStatus('Test sent!', 'success');
                } else {
                    showProviderStatus('Failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                showProviderStatus('Error: ' + err, 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Test Email';
            });
    }

    function showProviderStatus(message, type) {
        const el = document.getElementById('email-provider-status');
        el.textContent = message;
        el.className = 'email-test-status ' + type;
    }

    // Email Branding Functions
    function loadEmailBranding() {
        fetch('/api/settings')
            .then(r => r.json())
            .then(data => {
                const emailCfg = data.notifications?.email || {};
                document.getElementById('email-from-name').value = emailCfg.from_name || 'Plex Media Server';
                document.getElementById('email-weekly-subject').value = emailCfg.weekly_subject || 'Weekly Digest - New Additions';
            });
    }

    function saveEmailBranding() {
        const fromName = document.getElementById('email-from-name').value;
        const weeklySubject = document.getElementById('email-weekly-subject').value;

        fetch('/api/settings')
            .then(r => r.json())
            .then(currentSettings => {
                if (!currentSettings.notifications) currentSettings.notifications = {};
                if (!currentSettings.notifications.email) currentSettings.notifications.email = {};

                currentSettings.notifications.email.from_name = fromName;
                currentSettings.notifications.email.weekly_subject = weeklySubject;

                return fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentSettings)
                });
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showBrandingStatus('Saved!', 'success');
                } else {
                    showBrandingStatus('Save failed', 'error');
                }
            })
            .catch(err => {
                showBrandingStatus('Error: ' + err, 'error');
            });
    }

    function showBrandingStatus(message, type) {
        const el = document.getElementById('email-branding-status');
        el.textContent = message;
        el.className = 'email-test-status ' + type;
    }

    // Recipient list management
    let recipientsList = [];

    function loadNewsletterSettings() {
        fetch('/api/newsletter/settings')
            .then(r => r.json())
            .then(data => {
                document.getElementById('newsletter-frequency').value = data.frequency || 'weekly';
                document.getElementById('newsletter-day').value = data.day || 'thursday';
                document.getElementById('newsletter-hour').value = data.hour || 9;

                // Load recipients as objects with enabled flag
                if (data.recipients) {
                    // If recipients are strings, convert to objects
                    recipientsList = data.recipients.map(r => {
                        if (typeof r === 'string') {
                            return { email: r, enabled: true };
                        }
                        return r;
                    });
                    renderRecipients();
                }
            });
    }

    function renderRecipients() {
        const container = document.getElementById('recipients-list');
        if (recipientsList.length === 0) {
            container.innerHTML = '<div style="color: var(--text-muted); padding: 8px; text-align: center;">No recipients added</div>';
            return;
        }

        container.innerHTML = recipientsList.map((r, i) => {
            const suppressedBadge = r.suppressed
                ? '<span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">OPTED OUT</span>'
                : '';
            const isDisabled = r.suppressed ? 'disabled' : '';
            const textStyle = r.suppressed
                ? 'color: var(--text-muted); text-decoration: line-through;'
                : (r.enabled ? 'color: var(--text);' : 'color: var(--text-muted); text-decoration: line-through;');
            return `
                <div class="recipient-item" style="display: flex; align-items: center; gap: 8px; padding: 6px 4px; border-bottom: 1px solid var(--border);">
                    <input type="checkbox" ${r.enabled ? 'checked' : ''} ${isDisabled} onchange="toggleRecipient(${i})" style="cursor: ${r.suppressed ? 'not-allowed' : 'pointer'};">
                    <span style="flex: 1; ${textStyle}">${r.email}${suppressedBadge}</span>
                    <button onclick="removeRecipient(${i})" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px;" title="Remove">&times;</button>
                </div>
            `;
        }).join('');
    }

    function toggleRecipient(index) {
        recipientsList[index].enabled = !recipientsList[index].enabled;
        renderRecipients();
    }

    function addRecipient() {
        const input = document.getElementById('new-recipient');
        const email = input.value.trim();
        if (!email || !email.includes('@')) {
            showToast('Please enter a valid email address', 'error');
            return;
        }
        if (recipientsList.some(r => r.email === email)) {
            showToast('This email is already in the list', 'info');
            return;
        }
        recipientsList.push({ email: email, enabled: true });
        input.value = '';
        renderRecipients();
    }

    function removeRecipient(index) {
        recipientsList.splice(index, 1);
        renderRecipients();
    }

    function getEnabledRecipients() {
        return recipientsList.filter(r => r.enabled).map(r => r.email);
    }

    function syncSuppressions() {
        const btn = document.getElementById('btn-sync-suppressions');
        btn.disabled = true;
        btn.textContent = 'Syncing...';

        fetch('/api/email/sync-suppressions', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (data.updated > 0) {
                        showToast(`${data.updated} recipient(s) marked as opted out`, 'info');
                        loadNewsletterSettings(); // Reload to show badges
                    } else {
                        showToast('All recipients are valid', 'success');
                    }
                }
            })
            .catch(err => {
                showToast('Error syncing: ' + err, 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Sync Opt-outs';
            });
    }

    function loadQueue() {
        const container = document.getElementById('newsletter-preview');
        const dateRangeEl = document.getElementById('newsletter-date-range');

        fetch('/api/newsletter/preview')
            .then(r => r.json())
            .then(data => {
                // Update date range display
                if (data.start_date && data.end_date) {
                    dateRangeEl.textContent = `Content from ${data.start_date} to ${data.end_date} that will be included in the next digest`;
                }

                if (!data.rips || data.rips.length === 0) {
                    container.innerHTML = `<div class="queue-empty">No rips from ${data.start_date || 'last period'} to ${data.end_date || 'now'}</div>`;
                    return;
                }

                container.innerHTML = data.rips.map(rip => {
                    const discBadge = rip.disc_type || 'DVD';
                    const discColor = discBadge === 'BLURAY' ? '#0095d9' : '#f97316';
                    const contentType = rip.content_type || 'movie';
                    const typeLabel = contentType === 'tv' ? 'TV' : 'MOVIE';
                    const typeColor = contentType === 'tv' ? '#a855f7' : '#22c55e';
                    const date = rip.completed_at ? new Date(rip.completed_at).toLocaleDateString() : '';

                    return `
                        <div class="queue-item" style="display: flex; align-items: center; gap: 8px; padding: 8px 4px; border-bottom: 1px solid var(--border);">
                            <span style="background: ${typeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; min-width: 42px; text-align: center;">${typeLabel}</span>
                            <span style="background: ${discColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">${discBadge}</span>
                            <span style="flex: 1; color: var(--text);">${rip.title}</span>
                            <span style="color: var(--text-muted); font-size: 13px;">${rip.year || ''}</span>
                            <span style="color: var(--text-muted); font-size: 12px;">${date}</span>
                        </div>
                    `;
                }).join('');
            })
            .catch(err => {
                container.innerHTML = '<div class="queue-empty">Error loading preview</div>';
            });
    }

    document.getElementById('btn-save-newsletter').addEventListener('click', function() {
        const settings = {
            frequency: document.getElementById('newsletter-frequency').value,
            day: document.getElementById('newsletter-day').value,
            hour: parseInt(document.getElementById('newsletter-hour').value),
            recipients: recipientsList  // Send full list with enabled flags
        };

        fetch('/api/newsletter/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Newsletter settings saved!', 'success');
            }
        });
    });

    document.getElementById('btn-send-test').addEventListener('click', function() {
        this.disabled = true;
        this.textContent = 'Sending...';

        fetch('/api/newsletter/send-test', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Test email sent to your address only!', 'success');
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = 'Send Test Email';
            });
    });

</script>
{% endblock %}
