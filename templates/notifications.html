{% extends "base.html" %}

{% block title %}RipForge - Notifications{% endblock %}
{% block page_title %}Notifications{% endblock %}

{% block content %}
<div class="notifications-page">
    <!-- Sticky Save Bar -->
    <div class="sticky-save-bar" style="position: sticky; top: 0; z-index: 100; background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 12px 20px; margin: -20px -20px 20px -20px; display: flex; justify-content: space-between; align-items: center;">
        <span style="color: var(--text-muted); font-size: 14px;">Notification Settings</span>
        <div style="display: flex; gap: 12px; align-items: center;">
            <button class="btn btn-primary" id="btn-save-all-top" onclick="document.getElementById('btn-save-all').click()">Save All Settings</button>
            <span class="email-test-status" id="save-status-top"></span>
        </div>
    </div>

    <!-- Email Provider Settings -->
    <section class="card">
        <h2>Email Provider</h2>
        <p class="card-description">Configure how RipForge sends emails</p>

        <div class="newsletter-settings">
            <div class="settings-row">
                <div class="field">
                    <label>Provider</label>
                    <select id="email-provider" onchange="toggleSendGridKey()">
                        <option value="sendgrid">SendGrid (Recommended)</option>
                        <option value="msmtp">System Mail (msmtp)</option>
                    </select>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        SendGrid offers 100 free emails/day with better Gmail deliverability
                    </small>
                </div>
            </div>

            <div id="sendgrid-config" style="display: none; margin-top: 16px;">
                <div class="field">
                    <label>SendGrid API Key</label>
                    <input type="password" id="sendgrid-api-key" placeholder="SG.xxxxxxxxxx...">
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Get your free API key at <a href="https://app.sendgrid.com/settings/api_keys" target="_blank" style="color: var(--accent);">sendgrid.com</a> (100 emails/day free)
                    </small>
                </div>
                <div class="field" style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="check-suppressions" checked>
                        <span>Check SendGrid opt-outs before sending</span>
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Automatically skip recipients who have unsubscribed, bounced, or reported spam
                    </small>
                </div>
                <div class="field" style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="sendgrid-unsubscribe-footer" checked>
                        <span>Add unsubscribe link to emails</span>
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        SendGrid will append an unsubscribe link to all emails (recommended for compliance)
                    </small>
                </div>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveEmailProvider()">Save Provider</button>
                <button class="btn btn-secondary" onclick="testEmailProvider()">Test Email</button>
                <span class="email-test-status" id="email-provider-status"></span>
            </div>
        </div>
    </section>

    <!-- Email Branding -->
    <section class="card">
        <h2>Email Branding</h2>
        <p class="card-description">Customize how your weekly digest appears</p>

        <div class="newsletter-settings">
            <div class="field">
                <label>From Name</label>
                <input type="text" id="email-from-name" placeholder="Lakehouse Plex Media Server">
                <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                    This appears as the sender name (e.g., "Lakehouse Plex Media Server")
                </small>
            </div>
            <div class="field" style="margin-top: 16px;">
                <label>Subject Line</label>
                <input type="text" id="email-weekly-subject" placeholder="Weekly Digest - New Additions">
                <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                    The count will be appended automatically (e.g., "Weekly Digest - New Additions (5 titles)")
                </small>
            </div>
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveEmailBranding()">Save Branding</button>
                <span class="email-test-status" id="email-branding-status"></span>
            </div>
        </div>
    </section>

    <!-- Email Recipients -->
    <section class="card">
        <h2>Email Recipients</h2>
        <p class="card-description">Select who receives email notifications</p>

        <div class="newsletter-settings">
            <!-- Plex Users -->
            <div class="field">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="margin-bottom: 0;">Plex Users</label>
                    <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px;" onclick="syncSuppressions()" id="btn-sync-suppressions">
                        Sync Opt-outs
                    </button>
                </div>
                <div class="recipients-list" id="plex-users-list" style="max-height: 200px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 8px;">
                    <div style="color: var(--text-muted); padding: 8px; text-align: center;">Loading Plex users...</div>
                </div>
            </div>

            <!-- Additional Recipients -->
            <div class="field" style="margin-top: 16px;">
                <label>Additional Recipients</label>
                <div class="recipients-list" id="additional-recipients-list" style="max-height: 150px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 8px; margin-bottom: 12px;">
                    <!-- Manual recipients will be loaded here -->
                </div>
                <div style="display: flex; gap: 8px;">
                    <input type="email" id="new-recipient" placeholder="Add email address" style="flex: 1;">
                    <button class="btn btn-secondary" onclick="addManualRecipient()">Add</button>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                    Add recipients who aren't Plex users
                </small>
            </div>
        </div>
    </section>

    <!-- Notification Events -->
    <section class="card">
        <h2>Notification Events</h2>
        <p class="card-description">Choose when to send email notifications</p>

        <div class="newsletter-settings">
            <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
                <div class="field">
                    <label class="toggle-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="notify-complete">
                        <span>Email on Rip Complete</span>
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Send email when a disc finishes ripping
                    </small>
                </div>
                <div class="field">
                    <label class="toggle-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="notify-error">
                        <span>Email on Error</span>
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Send email if ripping fails
                    </small>
                </div>
                <div class="field">
                    <label class="toggle-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="notify-weekly">
                        <span>Weekly Digest</span>
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Send weekly summary of ripping activity
                    </small>
                </div>
                <div class="field">
                    <label class="toggle-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="notify-uncertain">
                        <span>Email on Uncertain ID</span>
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Send email when disc identification needs review
                    </small>
                </div>
            </div>
        </div>
    </section>

    <!-- Newsletter Schedule -->
    <section class="card">
        <h2>Weekly Digest Schedule</h2>
        <p class="card-description">Configure when to send the weekly digest email</p>

        <div class="newsletter-settings">
            <div class="settings-row">
                <div class="field">
                    <label>Frequency</label>
                    <select id="newsletter-frequency">
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Every 2 Weeks</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div class="field">
                    <label>Day</label>
                    <select id="newsletter-day">
                        <option value="sunday">Sunday</option>
                        <option value="monday">Monday</option>
                        <option value="tuesday">Tuesday</option>
                        <option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option>
                        <option value="friday">Friday</option>
                        <option value="saturday">Saturday</option>
                    </select>
                </div>
                <div class="field">
                    <label>Time</label>
                    <select id="newsletter-hour">
                        <option value="6">6:00 AM</option>
                        <option value="7">7:00 AM</option>
                        <option value="8">8:00 AM</option>
                        <option value="9">9:00 AM</option>
                        <option value="10">10:00 AM</option>
                        <option value="12">12:00 PM</option>
                        <option value="18">6:00 PM</option>
                    </select>
                </div>
            </div>
        </div>
    </section>

    <!-- Test & Save -->
    <section class="card">
        <h2>Save & Test</h2>
        <div class="newsletter-settings">
            <div class="settings-actions" style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                <button class="btn btn-primary" id="btn-save-all">Save All Settings</button>
                <button class="btn btn-secondary" id="btn-test-email" title="Send a test email to verify your email configuration is working">Send Test Email</button>
                <button class="btn btn-secondary" id="btn-send-recap" title="Send the weekly digest to all recipients now (does not reset the recently added list)">Send Weekly Digest Now</button>
                <button class="btn btn-outline" id="btn-reset-digest" title="Clear the recently added list so the next digest starts fresh">Reset Digest List</button>
                <span class="email-test-status" id="save-status"></span>
            </div>
        </div>
    </section>

    <!-- Newsletter Preview -->
    <section class="card">
        <h2>Newsletter Preview</h2>
        <p class="card-description" id="newsletter-date-range">Loading date range...</p>

        <div class="queue-list" id="newsletter-preview" style="max-height: 300px; overflow-y: auto;">
            <div class="queue-empty">Loading...</div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // State management
    let plexUsers = [];
    let manualRecipients = [];
    let configuredRecipients = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadEmailProvider();
        loadEmailBranding();
        loadAllSettings();
        loadQueue();
    });

    // Email Provider Functions
    function toggleSendGridKey() {
        const provider = document.getElementById('email-provider').value;
        document.getElementById('sendgrid-config').style.display =
            provider === 'sendgrid' ? 'block' : 'none';
    }

    function loadEmailProvider() {
        fetch('/api/settings')
            .then(r => r.json())
            .then(data => {
                const emailCfg = data.notifications?.email || {};
                document.getElementById('email-provider').value = emailCfg.provider || 'msmtp';
                document.getElementById('sendgrid-api-key').value = emailCfg.sendgrid_api_key || '';
                document.getElementById('check-suppressions').checked = emailCfg.check_suppressions !== false;
                document.getElementById('sendgrid-unsubscribe-footer').checked = emailCfg.sendgrid_unsubscribe_footer !== false;
                toggleSendGridKey();
            });
    }

    function saveEmailProvider() {
        const provider = document.getElementById('email-provider').value;
        const apiKey = document.getElementById('sendgrid-api-key').value;
        const checkSuppressions = document.getElementById('check-suppressions').checked;
        const unsubscribeFooter = document.getElementById('sendgrid-unsubscribe-footer').checked;

        fetch('/api/settings')
            .then(r => r.json())
            .then(currentSettings => {
                if (!currentSettings.notifications) currentSettings.notifications = {};
                if (!currentSettings.notifications.email) currentSettings.notifications.email = {};

                currentSettings.notifications.email.provider = provider;
                if (provider === 'sendgrid') {
                    currentSettings.notifications.email.sendgrid_api_key = apiKey;
                    currentSettings.notifications.email.check_suppressions = checkSuppressions;
                    currentSettings.notifications.email.sendgrid_unsubscribe_footer = unsubscribeFooter;
                }

                return fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentSettings)
                });
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showProviderStatus('Saved!', 'success');
                } else {
                    showProviderStatus('Save failed', 'error');
                }
            })
            .catch(err => {
                showProviderStatus('Error: ' + err, 'error');
            });
    }

    function testEmailProvider() {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Sending...';
        showProviderStatus('', '');

        fetch('/api/email/test', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showProviderStatus('Test sent!', 'success');
                } else {
                    showProviderStatus('Failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                showProviderStatus('Error: ' + err, 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Test Email';
            });
    }

    function showProviderStatus(message, type) {
        const el = document.getElementById('email-provider-status');
        el.textContent = message;
        el.className = 'email-test-status ' + type;
    }

    // Email Branding Functions
    function loadEmailBranding() {
        fetch('/api/settings')
            .then(r => r.json())
            .then(data => {
                const emailCfg = data.notifications?.email || {};
                document.getElementById('email-from-name').value = emailCfg.from_name || 'Plex Media Server';
                document.getElementById('email-weekly-subject').value = emailCfg.weekly_subject || 'Weekly Digest - New Additions';
            });
    }

    function saveEmailBranding() {
        const fromName = document.getElementById('email-from-name').value;
        const weeklySubject = document.getElementById('email-weekly-subject').value;

        fetch('/api/settings')
            .then(r => r.json())
            .then(currentSettings => {
                if (!currentSettings.notifications) currentSettings.notifications = {};
                if (!currentSettings.notifications.email) currentSettings.notifications.email = {};

                currentSettings.notifications.email.from_name = fromName;
                currentSettings.notifications.email.weekly_subject = weeklySubject;

                return fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentSettings)
                });
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showBrandingStatus('Saved!', 'success');
                } else {
                    showBrandingStatus('Save failed', 'error');
                }
            })
            .catch(err => {
                showBrandingStatus('Error: ' + err, 'error');
            });
    }

    function showBrandingStatus(message, type) {
        const el = document.getElementById('email-branding-status');
        el.textContent = message;
        el.className = 'email-test-status ' + type;
    }

    // Load all settings (recipients, event toggles, schedule)
    function loadAllSettings() {
        // Load general settings for event toggles
        fetch('/api/settings')
            .then(r => r.json())
            .then(data => {
                const emailCfg = data.notifications?.email || {};
                const rippingCfg = data.ripping || {};

                // Event toggles
                document.getElementById('notify-complete').checked = emailCfg.on_complete || false;
                document.getElementById('notify-error').checked = emailCfg.on_error || false;
                document.getElementById('notify-weekly').checked = emailCfg.weekly_recap || false;
                document.getElementById('notify-uncertain').checked = rippingCfg.notify_uncertain !== false;

                // Store configured recipients (normalize to strings)
                const rawRecipients = emailCfg.recipients || [];
                configuredRecipients = rawRecipients.map(r => typeof r === 'string' ? r : (r.email || r));
            });

        // Load newsletter schedule
        fetch('/api/newsletter/settings')
            .then(r => r.json())
            .then(data => {
                document.getElementById('newsletter-frequency').value = data.frequency || 'weekly';
                document.getElementById('newsletter-day').value = data.day || 'thursday';
                document.getElementById('newsletter-hour').value = data.hour || 9;
            });

        // Load Plex users
        loadPlexUsers();
    }

    // Load Plex users from API
    function loadPlexUsers() {
        fetch('/api/plex/users')
            .then(r => r.json())
            .then(data => {
                plexUsers = data.users || [];
                renderPlexUsers();
                renderManualRecipients();
            })
            .catch(err => {
                console.error('Error loading Plex users:', err);
                document.getElementById('plex-users-list').innerHTML =
                    '<div style="color: var(--text-muted); padding: 8px; text-align: center;">Could not load Plex users. Check Plex integration settings.</div>';
                renderManualRecipients();
            });
    }

    // Render Plex users with checkboxes
    function renderPlexUsers() {
        const container = document.getElementById('plex-users-list');

        if (plexUsers.length === 0) {
            container.innerHTML = '<div style="color: var(--text-muted); padding: 8px; text-align: center;">No Plex users found. Configure Plex in Settings.</div>';
            return;
        }

        const plexEmails = plexUsers.map(u => u.email);

        container.innerHTML = plexUsers.map((user, idx) => {
            const isEnabled = configuredRecipients.includes(user.email);
            const typeLabel = user.type === 'owner' ? 'Owner' : (user.type === 'home' ? 'Home' : 'Friend');
            const typeBadgeColor = user.type === 'owner' ? '#22c55e' : (user.type === 'home' ? '#3b82f6' : '#a855f7');

            return `
                <div class="recipient-item" style="display: flex; align-items: center; gap: 8px; padding: 6px 4px; border-bottom: 1px solid var(--border);">
                    <input type="checkbox" class="plex-user-checkbox" data-email="${user.email}" ${isEnabled ? 'checked' : ''} style="cursor: pointer;">
                    <span style="flex: 1; color: var(--text);">
                        <span>${user.email}</span>
                        <span style="color: var(--text-muted); font-size: 12px; margin-left: 8px;">${user.username}</span>
                    </span>
                    <span style="background: ${typeBadgeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${typeLabel}</span>
                </div>
            `;
        }).join('');

        // After rendering Plex users, identify manual recipients (not in Plex)
        manualRecipients = configuredRecipients.filter(email => !plexEmails.includes(email));
    }

    // Render manual (non-Plex) recipients
    function renderManualRecipients() {
        const container = document.getElementById('additional-recipients-list');
        const plexEmails = plexUsers.map(u => u.email);

        // Filter out Plex emails from manual list
        manualRecipients = manualRecipients.filter(email => !plexEmails.includes(email));

        if (manualRecipients.length === 0) {
            container.innerHTML = '<div style="color: var(--text-muted); padding: 8px; text-align: center;">No additional recipients</div>';
            return;
        }

        container.innerHTML = manualRecipients.map((email, i) => {
            return `
                <div class="recipient-item" style="display: flex; align-items: center; gap: 8px; padding: 6px 4px; border-bottom: 1px solid var(--border);">
                    <input type="checkbox" class="manual-recipient-checkbox" data-email="${email}" checked style="cursor: pointer;">
                    <span style="flex: 1; color: var(--text);">${email}</span>
                    <button onclick="removeManualRecipient(${i})" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px;" title="Remove">&times;</button>
                </div>
            `;
        }).join('');
    }

    // Add manual recipient
    function addManualRecipient() {
        const input = document.getElementById('new-recipient');
        const email = input.value.trim();

        if (!email || !email.includes('@')) {
            showToast('Please enter a valid email address', 'error');
            return;
        }

        // Check if already exists in Plex users or manual list
        const plexEmails = plexUsers.map(u => u.email);
        if (plexEmails.includes(email)) {
            showToast('This email is already a Plex user', 'info');
            return;
        }
        if (manualRecipients.includes(email)) {
            showToast('This email is already in the list', 'info');
            return;
        }

        manualRecipients.push(email);
        input.value = '';
        renderManualRecipients();
    }

    // Remove manual recipient
    function removeManualRecipient(index) {
        manualRecipients.splice(index, 1);
        renderManualRecipients();
    }

    // Get all selected recipients
    function getSelectedRecipients() {
        const recipients = [];

        // Get enabled Plex users
        document.querySelectorAll('.plex-user-checkbox:checked').forEach(cb => {
            recipients.push(cb.dataset.email);
        });

        // Get enabled manual recipients
        document.querySelectorAll('.manual-recipient-checkbox:checked').forEach(cb => {
            if (!recipients.includes(cb.dataset.email)) {
                recipients.push(cb.dataset.email);
            }
        });

        return recipients;
    }

    // Sync suppressions from SendGrid
    function syncSuppressions() {
        const btn = document.getElementById('btn-sync-suppressions');
        btn.disabled = true;
        btn.textContent = 'Syncing...';

        fetch('/api/email/sync-suppressions', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (data.updated > 0) {
                        showToast(`${data.updated} recipient(s) marked as opted out`, 'info');
                        loadAllSettings();
                    } else {
                        showToast('All recipients are valid', 'success');
                    }
                }
            })
            .catch(err => {
                showToast('Error syncing: ' + err, 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Sync Opt-outs';
            });
    }

    // Load newsletter preview
    function loadQueue() {
        const container = document.getElementById('newsletter-preview');
        const dateRangeEl = document.getElementById('newsletter-date-range');

        fetch('/api/newsletter/preview')
            .then(r => r.json())
            .then(data => {
                if (data.start_date && data.end_date) {
                    dateRangeEl.textContent = `Recently added content that will be included in the next digest (${data.start_date} - ${data.end_date})`;
                }

                if (!data.rips || data.rips.length === 0) {
                    container.innerHTML = `<div class="queue-empty">No rips from ${data.start_date || 'last period'} to ${data.end_date || 'now'}</div>`;
                    return;
                }

                container.innerHTML = data.rips.map(rip => {
                    const discBadge = rip.disc_type || 'DVD';
                    const discColor = discBadge === 'BLURAY' ? '#0095d9' : '#f97316';
                    const contentType = rip.content_type || 'movie';
                    const typeLabel = contentType === 'tv' ? 'TV' : 'MOVIE';
                    const typeColor = contentType === 'tv' ? '#a855f7' : '#22c55e';
                    const date = rip.completed_at ? new Date(rip.completed_at).toLocaleDateString() : '';

                    return `
                        <div class="queue-item" style="display: flex; align-items: center; gap: 8px; padding: 8px 4px; border-bottom: 1px solid var(--border);">
                            <span style="background: ${typeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; min-width: 42px; text-align: center;">${typeLabel}</span>
                            <span style="background: ${discColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">${discBadge}</span>
                            <span style="flex: 1; color: var(--text);">${rip.title}</span>
                            <span style="color: var(--text-muted); font-size: 13px;">${rip.year || ''}</span>
                            <span style="color: var(--text-muted); font-size: 12px;">${date}</span>
                        </div>
                    `;
                }).join('');
            })
            .catch(err => {
                container.innerHTML = '<div class="queue-empty">Error loading preview</div>';
            });
    }

    // Show save status
    function showSaveStatus(message, type) {
        // Update both top and bottom status indicators
        ['save-status', 'save-status-top'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = message;
                el.className = 'email-test-status ' + type;
            }
        });
    }

    // Save all notification settings
    document.getElementById('btn-save-all').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Saving...';
        showSaveStatus('', '');

        // Get all selected recipients
        const recipients = getSelectedRecipients();

        // Save newsletter schedule
        const newsletterSettings = {
            frequency: document.getElementById('newsletter-frequency').value,
            day: document.getElementById('newsletter-day').value,
            hour: parseInt(document.getElementById('newsletter-hour').value),
            recipients: recipients
        };

        // Save event toggles via /api/settings
        fetch('/api/settings')
            .then(r => r.json())
            .then(currentSettings => {
                if (!currentSettings.notifications) currentSettings.notifications = {};
                if (!currentSettings.notifications.email) currentSettings.notifications.email = {};
                if (!currentSettings.ripping) currentSettings.ripping = {};

                // Update email event flags
                currentSettings.notifications.email.on_complete = document.getElementById('notify-complete').checked;
                currentSettings.notifications.email.on_error = document.getElementById('notify-error').checked;
                currentSettings.notifications.email.weekly_recap = document.getElementById('notify-weekly').checked;
                currentSettings.notifications.email.recipients = recipients;

                // Update ripping notify_uncertain flag
                currentSettings.ripping.notify_uncertain = document.getElementById('notify-uncertain').checked;

                return fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentSettings)
                });
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) throw new Error('Failed to save settings');

                // Also save newsletter schedule
                return fetch('/api/newsletter/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newsletterSettings)
                });
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showSaveStatus('Saved!', 'success');
                    showToast('All notification settings saved!', 'success');
                } else {
                    throw new Error('Failed to save newsletter settings');
                }
            })
            .catch(err => {
                showSaveStatus('Error', 'error');
                showToast('Error saving: ' + err, 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Save All Settings';
            });
    });

    // Test email button
    document.getElementById('btn-test-email').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Sending...';
        showSaveStatus('', '');

        const recipients = getSelectedRecipients();
        if (recipients.length === 0) {
            showSaveStatus('No recipients selected', 'error');
            btn.disabled = false;
            btn.textContent = 'Send Test Email';
            return;
        }

        fetch('/api/email/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recipients: [recipients[0]] })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showSaveStatus('Test sent!', 'success');
                showToast('Test email sent to ' + recipients[0], 'success');
            } else {
                showSaveStatus('Failed', 'error');
                showToast(data.error || 'Failed to send', 'error');
            }
        })
        .catch(err => {
            showSaveStatus('Error', 'error');
            showToast('Error: ' + err, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Send Test Email';
        });
    });

    // Weekly digest button
    document.getElementById('btn-send-recap').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Sending...';
        showSaveStatus('', '');

        const recipients = getSelectedRecipients();
        if (recipients.length === 0) {
            showSaveStatus('No recipients selected', 'error');
            btn.disabled = false;
            btn.textContent = 'Send Weekly Digest Now';
            return;
        }

        fetch('/api/email/weekly-recap', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recipients })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showSaveStatus('Sent!', 'success');
                showToast('Weekly digest sent to ' + recipients.length + ' recipient(s)', 'success');
            } else {
                showSaveStatus('Failed', 'error');
                showToast(data.error || 'Failed to send', 'error');
            }
        })
        .catch(err => {
            showSaveStatus('Error', 'error');
            showToast('Error: ' + err, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Send Weekly Digest Now';
        });
    });

    // Reset Digest List button
    document.getElementById('btn-reset-digest').addEventListener('click', function() {
        if (!confirm('This will clear the "recently added" list. The next digest will only include content added after this point. Continue?')) {
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Resetting...';

        fetch('/api/email/reset-digest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Digest list cleared', 'success');
                showSaveStatus('Digest list cleared', 'success');
                // Refresh the preview to show empty list
                loadNewsletterPreview();
            } else {
                showToast('Error: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(err => {
            showToast('Error: ' + err, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Reset Digest List';
        });
    });

</script>
{% endblock %}
