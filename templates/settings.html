{% extends "base.html" %}

{% block title %}RipForge - Settings{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<div class="settings">
    <!-- Auto-detect Banner -->
    <section class="card auto-detect">
        <div class="auto-detect-content">
            <div>
                <h3>Auto-Detect Services</h3>
                <p>Scan for Docker containers and import existing API keys</p>
            </div>
            <button class="btn btn-primary" id="btn-auto-detect">
                <span class="btn-icon">üîç</span> Auto-Detect
            </button>
        </div>
    </section>

    <!-- Integrations -->
    <section class="card">
        <h2>Integrations</h2>

        <!-- Radarr -->
        <div class="integration-config">
            <div class="integration-header">
                <label class="toggle">
                    <input type="checkbox" id="radarr-enabled" {% if config.integrations.radarr.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span class="integration-title">Radarr</span>
                <span class="integration-badge" id="radarr-status">Not tested</span>
            </div>
            <div class="integration-fields">
                <div class="field">
                    <label>URL</label>
                    <input type="text" id="radarr-url" value="{{ config.integrations.radarr.url }}" placeholder="http://localhost:7878">
                </div>
                <div class="field">
                    <label>API Key</label>
                    <input type="password" id="radarr-api" value="{{ config.integrations.radarr.api_key }}" placeholder="Enter API key">
                </div>
                <button class="btn btn-small" onclick="testConnection('radarr')">Test Connection</button>
            </div>
        </div>

        <!-- Sonarr -->
        <div class="integration-config">
            <div class="integration-header">
                <label class="toggle">
                    <input type="checkbox" id="sonarr-enabled" {% if config.integrations.sonarr.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span class="integration-title">Sonarr</span>
                <span class="integration-badge" id="sonarr-status">Not tested</span>
            </div>
            <div class="integration-fields">
                <div class="field">
                    <label>URL</label>
                    <input type="text" id="sonarr-url" value="{{ config.integrations.sonarr.url }}" placeholder="http://localhost:8989">
                </div>
                <div class="field">
                    <label>API Key</label>
                    <input type="password" id="sonarr-api" value="{{ config.integrations.sonarr.api_key }}" placeholder="Enter API key">
                </div>
                <button class="btn btn-small" onclick="testConnection('sonarr')">Test Connection</button>
            </div>
        </div>

        <!-- Overseerr -->
        <div class="integration-config">
            <div class="integration-header">
                <label class="toggle">
                    <input type="checkbox" id="overseerr-enabled" {% if config.integrations.overseerr.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span class="integration-title">Overseerr</span>
                <span class="integration-badge" id="overseerr-status">Not tested</span>
            </div>
            <div class="integration-fields">
                <div class="field">
                    <label>URL</label>
                    <input type="text" id="overseerr-url" value="{{ config.integrations.overseerr.url }}" placeholder="http://localhost:5055">
                </div>
                <div class="field">
                    <label>API Key</label>
                    <input type="password" id="overseerr-api" value="{{ config.integrations.overseerr.api_key }}" placeholder="Enter API key">
                </div>
                <button class="btn btn-small" onclick="testConnection('overseerr')">Test Connection</button>
            </div>
        </div>

        <!-- Plex -->
        <div class="integration-config">
            <div class="integration-header">
                <label class="toggle">
                    <input type="checkbox" id="plex-enabled" {% if config.integrations.plex.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span class="integration-title">Plex</span>
                <span class="integration-badge" id="plex-status">Not tested</span>
            </div>
            <div class="integration-fields">
                <div class="field">
                    <label>URL</label>
                    <input type="text" id="plex-url" value="{{ config.integrations.plex.url }}" placeholder="http://localhost:32400">
                </div>
                <div class="field">
                    <label>Token</label>
                    <input type="password" id="plex-token" value="{{ config.integrations.plex.token }}" placeholder="Enter Plex token">
                </div>
                <button class="btn btn-small" onclick="testConnection('plex')">Test Connection</button>
            </div>
        </div>

        <!-- Tautulli -->
        <div class="integration-config">
            <div class="integration-header">
                <label class="toggle">
                    <input type="checkbox" id="tautulli-enabled" {% if config.integrations.tautulli.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span class="integration-title">Tautulli</span>
                <span class="integration-badge" id="tautulli-status">Not tested</span>
            </div>
            <div class="integration-fields">
                <div class="field">
                    <label>URL</label>
                    <input type="text" id="tautulli-url" value="{{ config.integrations.tautulli.url }}" placeholder="http://localhost:8181">
                </div>
                <div class="field">
                    <label>API Key</label>
                    <input type="password" id="tautulli-api" value="{{ config.integrations.tautulli.api_key }}" placeholder="Enter API key">
                </div>
                <button class="btn btn-small" onclick="testConnection('tautulli')">Test Connection</button>
            </div>
        </div>
    </section>

    <!-- Community Disc Database -->
    <section class="card">
        <h2>Community Disc Database</h2>
        <p class="card-description">Shared database of disc label identifications. If you use it, you contribute.</p>
        <div class="integration-config">
            <div class="integration-header">
                <label class="toggle">
                    <input type="checkbox" id="community-db-enabled" {% if not config.community_db or config.community_db.enabled != false %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span class="integration-title">Community Database</span>
                <span class="integration-badge" id="community-db-status">-</span>
            </div>
            <div class="community-db-info">
                <p>Many discs have cryptic labels like <code>SC30NNW1</code> instead of <code>SANTA_CLAUSE_3</code>.</p>
                <p>When enabled:</p>
                <ul>
                    <li>Cryptic disc labels are auto-identified from community contributions</li>
                    <li>Your manual identifications are shared back to help others</li>
                </ul>
                <p class="privacy-note">Only shares: disc label, type, duration, title, year, TMDB ID. No personal data.</p>
            </div>
        </div>
    </section>

    <!-- Ripping Settings -->
    <section class="card">
        <h2>Ripping Settings</h2>
        <div class="settings-grid">
            <div class="field">
                <label>Minimum Track Length (seconds)</label>
                <input type="number" id="min-length" value="{{ config.ripping.min_length }}">
                <small>Tracks shorter than this will be skipped (2700 = 45 min)</small>
            </div>
            <div class="field">
                <label class="toggle-label">
                    <input type="checkbox" id="main-feature-only" {% if config.ripping.main_feature_only %}checked{% endif %}>
                    <span>Main Feature Only</span>
                </label>
                <small>Only rip the longest track (main movie)</small>
            </div>
            <div class="field rip-mode-field">
                <label>Rip Mode <span style="color: var(--text-muted); font-weight: normal;">(Blu-ray only)</span></label>
                <select id="rip-mode">
                    <option value="smart" {% if config.ripping.rip_mode == 'smart' or not config.ripping.rip_mode %}selected{% endif %}>Smart (Recommended)</option>
                    <option value="always_backup" {% if config.ripping.rip_mode == 'always_backup' %}selected{% endif %}>Always Backup</option>
                    <option value="direct_only" {% if config.ripping.rip_mode == 'direct_only' %}selected{% endif %}>Direct Only</option>
                </select>
            </div>
            <div class="field">
                <label class="toggle-label">
                    <input type="checkbox" id="skip-transcode" {% if config.ripping.skip_transcode %}checked{% endif %}>
                    <span>Skip Transcoding</span>
                </label>
                <small>Keep original MakeMKV quality</small>
            </div>
            <div class="field">
                <label>Preferred Language</label>
                <select id="preferred-language">
                    <option value="eng" {% if config.ripping.preferred_language == 'eng' or not config.ripping.preferred_language %}selected{% endif %}>English</option>
                    <option value="spa" {% if config.ripping.preferred_language == 'spa' %}selected{% endif %}>Spanish</option>
                    <option value="fra" {% if config.ripping.preferred_language == 'fra' %}selected{% endif %}>French</option>
                    <option value="deu" {% if config.ripping.preferred_language == 'deu' %}selected{% endif %}>German</option>
                    <option value="ita" {% if config.ripping.preferred_language == 'ita' %}selected{% endif %}>Italian</option>
                    <option value="por" {% if config.ripping.preferred_language == 'por' %}selected{% endif %}>Portuguese</option>
                    <option value="jpn" {% if config.ripping.preferred_language == 'jpn' %}selected{% endif %}>Japanese</option>
                    <option value="all" {% if config.ripping.preferred_language == 'all' %}selected{% endif %}>Keep All Languages</option>
                </select>
                <small>Audio/subtitle tracks in this language will be marked as default</small>
            </div>
            <div class="field">
                <label class="toggle-label">
                    <input type="checkbox" id="keep-commentary" {% if config.ripping.keep_commentary %}checked{% endif %}>
                    <span>Keep Commentary Tracks</span>
                </label>
                <small>Include director commentary and other secondary audio</small>
            </div>
        </div>
        <div class="rip-mode-info" id="rip-mode-info">
            <div class="mode-details" id="mode-smart">
                <strong>Smart:</strong> Tries direct rip first (fastest). If copy protection is detected, automatically retries via backup method.
            </div>
            <div class="mode-details" id="mode-always_backup" style="display:none;">
                <strong>Always Backup:</strong> Decrypts full disc first (~50GB temp space), then extracts. Best for Blu-ray, Star Wars, Disney, and copy-protected discs. More accurate track identification.
            </div>
            <div class="mode-details" id="mode-direct_only" style="display:none;">
                <strong>Direct Only:</strong> Fastest method, no fallback. Best for DVDs and unprotected discs.
            </div>
        </div>
    </section>

    <!-- Auto-Rip Settings -->
    <section class="card">
        <h2>Auto-Rip</h2>
        <p class="card-description">Configure automatic scanning and ripping behavior</p>
        <div class="settings-grid">
            <div class="field">
                <label class="toggle-label">
                    <input type="checkbox" id="auto-scan-on-insert" {% if config.ripping.auto_scan_on_insert != false %}checked{% endif %}>
                    <span>Auto-Scan on Disc Insert</span>
                </label>
                <small>Automatically scan when a disc is inserted</small>
            </div>
            <div class="field">
                <label class="toggle-label">
                    <input type="checkbox" id="auto-rip" {% if config.ripping.auto_rip != false %}checked{% endif %}>
                    <span>Auto-Rip After Scan</span>
                </label>
                <small>Start ripping automatically after countdown</small>
            </div>
            <div class="field">
                <label>Auto-Rip Countdown (seconds)</label>
                <input type="number" id="auto-rip-delay" value="{{ config.ripping.auto_rip_delay if config.ripping.auto_rip_delay is not none else 20 }}" min="0" max="120">
                <small>Time to review before auto-rip starts (0 = immediate)</small>
            </div>
            <div class="field">
                <label>Confidence Threshold (%)</label>
                <input type="number" id="confidence-threshold" value="{{ config.ripping.confidence_threshold if config.ripping.confidence_threshold is not none else 75 }}" min="0" max="100">
                <small>Below this, disc needs manual review before ripping</small>
            </div>
            <div class="field">
                <label class="toggle-label">
                    <input type="checkbox" id="notify-uncertain" {% if config.ripping.notify_uncertain != false %}checked{% endif %}>
                    <span>Email on Uncertain ID</span>
                </label>
                <small>Send email when disc identification needs review</small>
            </div>
            <div class="field">
                <label class="toggle-label">
                    <input type="checkbox" id="eject-when-done" {% if config.ripping.eject_when_done %}checked{% endif %}>
                    <span>Eject Disc When Done</span>
                </label>
                <small>Automatically eject disc after ripping completes</small>
            </div>
            <div class="field">
                <label class="toggle-label">
                    <input type="checkbox" id="debug-logging" {% if config.ripping.debug_logging %}checked{% endif %}>
                    <span>Debug Logging</span>
                </label>
                <small>Show raw MakeMKV protocol messages in activity log</small>
            </div>
        </div>
    </section>

    <!-- Paths -->
    <section class="card">
        <h2>Paths</h2>
        <p class="card-description">Disc ‚Üí Raw Rips (temp) ‚Üí Identified & renamed ‚Üí Moved to Library</p>
        <div class="paths-flow">
            <div class="path-group">
                <div class="path-group-label">Staging</div>
                <div class="field">
                    <label>Raw Rips</label>
                    <input type="text" id="path-raw" value="{{ config.paths.raw_rips }}">
                    <small>Temporary location for ripped files before moving</small>
                </div>
            </div>
            <div class="path-arrow">‚Üí</div>
            <div class="path-group">
                <div class="path-group-label">Library</div>
                <div class="field">
                    <label>Movies</label>
                    <input type="text" id="path-movies" value="{{ config.paths.movies }}">
                </div>
                <div class="field">
                    <label>TV Shows</label>
                    <input type="text" id="path-tv" value="{{ config.paths.tv }}">
                </div>
            </div>
        </div>
    </section>

    <!-- Notifications -->
    <section class="card">
        <h2>Email Notifications</h2>
        <p style="color: var(--text-muted); margin-bottom: 16px;">
            Manage email recipients, notification events, and weekly digest settings.
        </p>
        <a href="/notifications" class="btn btn-primary">
            Go to Notifications Settings
        </a>
    </section>

    <!-- Updates -->
    <section class="card">
        <h2>Updates</h2>
        <div class="update-status">
            <div class="update-info">
                <span class="update-label">Current version:</span>
                <span id="current-version">Loading...</span>
                <span class="version-dot" id="settings-version-dot" title="Checking...">‚óè</span>
            </div>
            <div class="update-info" id="latest-version-row" style="display: none;">
                <span class="update-label">Latest version:</span>
                <span id="latest-version">-</span>
            </div>
            <div class="update-info" id="last-check-row">
                <span class="update-label">Last checked:</span>
                <span id="last-check-time">Never</span>
            </div>
            <div class="update-actions">
                <button class="btn btn-secondary" id="btn-check-updates">Check Now</button>
                <button class="btn btn-update" id="btn-settings-update" style="display: none;">Install Update</button>
            </div>
        </div>
    </section>

    <!-- Optical Drive Status -->
    <section class="card">
        <h2>Optical Drive</h2>
        <div class="drive-status" id="optical-drive-info">
            <div class="drive-status-loading">Loading drive info...</div>
        </div>
    </section>

    <!-- Save Button -->

    <!-- CLI Cheatsheet -->
    <section class="card cli-cheatsheet">
        <div class="cheatsheet-header">
            <h2>CLI Cheatsheet</h2>
            <span class="os-badge" id="os-badge">Loading...</span>
        </div>
        <p class="card-description">Commands customized for this server</p>
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" id="btn-restart-service" onclick="restartService()">
                üîÑ Restart Service
            </button>
        </div>
        <div class="cheatsheet-grid">
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Restart Service</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">sudo systemctl restart ripforge</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Service Status</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">systemctl status ripforge</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">View Logs (live)</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">tail -f ~/ripforge/logs/activity.log</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">View Logs (last 50)</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">tail -50 ~/ripforge/logs/activity.log</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Pull Updates</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">cd ~/ripforge && git pull</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Edit Config</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">nano ~/ripforge/config/settings.yaml</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Check Drive</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">lsblk | grep sr</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Eject Disc</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">eject /dev/sr0</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">MakeMKV Info</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">makemkvcon -r info disc:0</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Disk Space</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">df -h /mnt/media</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Rescan SCSI (drive missing)</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">echo '- - -' | sudo tee /sys/class/scsi_host/host*/scan</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
            <div class="cheatsheet-item">
                <div class="cheatsheet-label">Check Hardware Errors</div>
                <div class="cheatsheet-code-wrap">
                    <code class="cheatsheet-code">dmesg | tail -30</code>
                    <button class="copy-btn" onclick="copyCommand(this)" title="Copy to clipboard">üìã</button>
                </div>
            </div>
        </div>
    </section>
    <div class="settings-actions">
        <button class="btn btn-primary btn-large" id="btn-save">
            <span class="btn-icon">üíæ</span> Save Settings
        </button>
    </div>
</div>

<style>
.cli-cheatsheet .cheatsheet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}
.cli-cheatsheet .cheatsheet-header h2 {
    margin: 0;
}
.cheatsheet-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}
@media (max-width: 900px) {
    .cheatsheet-grid {
        grid-template-columns: 1fr;
    }
}
.cheatsheet-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.cheatsheet-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.cheatsheet-code-wrap {
    display: flex;
    align-items: stretch;
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    overflow: hidden;
}
.cheatsheet-code {
    flex: 1;
    font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 13px;
    color: #e2e8f0;
    padding: 10px 14px;
    background: transparent;
    border: none;
    overflow-x: auto;
    white-space: nowrap;
}
.copy-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    background: rgba(255, 255, 255, 0.05);
    border: none;
    border-left: 1px solid #30363d;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s ease;
}
.copy-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
}
.copy-btn.copied {
    background: rgba(74, 222, 128, 0.2);
    color: var(--success);
}
.os-badge {
    background: var(--bg-dark);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    color: var(--warning);
    font-family: monospace;
}
.drive-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
}
.drive-stat {
    background: var(--bg-dark);
    border-radius: 8px;
    padding: 12px 16px;
}
.drive-stat-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
}
.drive-stat-value {
    font-size: 14px;
    color: var(--text);
    font-weight: 500;
}
.drive-stat-value.success {
    color: var(--success);
}
.drive-stat-value.warning {
    color: var(--warning);
}
.drive-stat-value.error {
    color: var(--error);
}
.drive-status-loading {
    color: var(--text-muted);
    padding: 20px;
    text-align: center;
}
</style>

{% endblock %}

{% block scripts %}
<script>
    // Restart service
    function restartService() {
        const btn = document.getElementById('btn-restart-service');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Restarting...';

        fetch('/api/service/restart', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Service restarting...', 'success');
                    btn.innerHTML = '‚úì Restarting...';
                    // Page will lose connection, countdown to reload
                    setTimeout(() => {
                        btn.innerHTML = 'Reloading in 3...';
                        setTimeout(() => {
                            btn.innerHTML = 'Reloading in 2...';
                            setTimeout(() => {
                                btn.innerHTML = 'Reloading in 1...';
                                setTimeout(() => window.location.reload(), 1000);
                            }, 1000);
                        }, 1000);
                    }, 1000);
                } else {
                    showToast('Restart failed: ' + (data.error || 'Unknown error'), 'error');
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Restart Service';
                }
            })
            .catch(() => {
                // Connection lost means restart is happening
                showToast('Service restarting...', 'success');
                setTimeout(() => window.location.reload(), 4000);
            });
    }

    // Copy to clipboard
    function copyToClipboard(el) {
        navigator.clipboard.writeText(el.textContent).then(() => {
            el.classList.add("copied");
            const original = el.textContent;
            el.textContent = "Copied!";
            setTimeout(() => {
                el.textContent = original;
                el.classList.remove("copied");
            }, 1500);
        });
    }

    function copyCommand(btn) {
        const codeEl = btn.parentElement.querySelector('.cheatsheet-code');
        if (!codeEl) return;

        navigator.clipboard.writeText(codeEl.textContent).then(() => {
            btn.classList.add("copied");
            btn.textContent = "‚úì";
            setTimeout(() => {
                btn.textContent = "üìã";
                btn.classList.remove("copied");
            }, 1500);
        });
    }

    // Load optical drive status
    function loadDriveStatus() {
        fetch('/api/drive/status')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('optical-drive-info');

                // Handle busy state with no cached data
                if (data.busy && !data.drive_model) {
                    container.innerHTML = '<div class="drive-status-loading">Drive busy (scan/rip in progress)</div>';
                    return;
                }

                // Handle error with no data
                if (data.error && !data.drive_model) {
                    container.innerHTML = `<div class="drive-status-loading" style="color: var(--error);">${data.error}</div>`;
                    return;
                }

                let html = '<div class="drive-status-grid">';

                // Show cached indicator if applicable
                if (data.cached && data.cache_age_minutes > 0) {
                    html = `<div style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">Cached ${data.cache_age_minutes}m ago${data.busy ? ' (drive busy)' : ''}</div>` + html;
                }

                // Drive Model
                html += `<div class="drive-stat">
                    <div class="drive-stat-label">Drive Model</div>
                    <div class="drive-stat-value">${data.drive_model || 'Unknown'}</div>
                </div>`;

                // Firmware
                if (data.drive_firmware) {
                    html += `<div class="drive-stat">
                        <div class="drive-stat-label">Firmware</div>
                        <div class="drive-stat-value">${data.drive_firmware}</div>
                    </div>`;
                }

                // LibreDrive Status (only shown when disc present, since it requires disc access to detect)
                if (data.libre_drive) {
                    html += `<div class="drive-stat">
                        <div class="drive-stat-label">LibreDrive</div>
                        <div class="drive-stat-value success">
                            ‚úì Enabled${data.libre_drive_version ? ' (v' + data.libre_drive_version + ')' : ''}
                        </div>
                    </div>`;
                } else if (data.disc_present) {
                    // Disc present but LibreDrive not detected
                    html += `<div class="drive-stat">
                        <div class="drive-stat-label">LibreDrive</div>
                        <div class="drive-stat-value warning">‚úó Not detected</div>
                    </div>`;
                }
                // Don't show LibreDrive status if no disc - can't detect without disc access

                // MakeMKV Version
                if (data.makemkv_version) {
                    html += `<div class="drive-stat">
                        <div class="drive-stat-label">MakeMKV</div>
                        <div class="drive-stat-value">v${data.makemkv_version}</div>
                    </div>`;
                }

                // Disc Status
                html += `<div class="drive-stat">
                    <div class="drive-stat-label">Disc</div>
                    <div class="drive-stat-value ${data.disc_present ? 'success' : ''}">
                        ${data.disc_present ? (data.disc_label || 'Present') : 'No disc'}
                    </div>
                </div>`;

                // Access Mode
                if (data.access_mode) {
                    html += `<div class="drive-stat">
                        <div class="drive-stat-label">Access Mode</div>
                        <div class="drive-stat-value">${data.access_mode}</div>
                    </div>`;
                }

                html += '</div>';
                container.innerHTML = html;
            })
            .catch(err => {
                document.getElementById('optical-drive-info').innerHTML =
                    '<div class="drive-status-loading" style="color: var(--error);">Failed to load drive status</div>';
            });
    }

    // Load drive status on page load
    loadDriveStatus();

    // Auto-detect button
    document.getElementById('btn-auto-detect').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<span class="btn-icon">‚è≥</span> Detecting...';

        fetch('/api/auto-detect', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                console.log('Auto-detect result:', data);

                const numServices = Object.keys(data.services).length;
                const numKeys = Object.keys(data.keys).length;

                if (data.applied) {
                    // Settings were saved - reload the page to show new values
                    showToast('Auto-detection complete! Found ' + numServices + ' services and ' + numKeys + ' API keys. Reloading...', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    // Fill in detected services (fallback if not auto-saved)
                    for (const [service, info] of Object.entries(data.services)) {
                        if (info.detected) {
                            document.getElementById(service + '-url').value = info.url;
                            document.getElementById(service + '-enabled').checked = true;
                        }
                    }

                    if (data.keys.radarr_api) {
                        document.getElementById('radarr-api').value = data.keys.radarr_api;
                    }
                    if (data.keys.sonarr_api) {
                        document.getElementById('sonarr-api').value = data.keys.sonarr_api;
                    }
                    if (data.keys.plex_token) {
                        document.getElementById('plex-token').value = data.keys.plex_token;
                    }
                    if (data.keys.tautulli_api) {
                        document.getElementById('tautulli-api').value = data.keys.tautulli_api;
                    }

                    showToast('Auto-detection complete! Found ' + numServices + ' services and ' + numKeys + ' API keys. Click Save to apply.', 'success');
                }
            })
            .catch(err => {
                console.error('Auto-detect error:', err);
                showToast('Error during auto-detection', 'error');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<span class="btn-icon">üîç</span> Auto-Detect';
            });
    });

    // Test connection
    function testConnection(service) {
        const url = document.getElementById(service + '-url').value;
        const apiKey = document.getElementById(service + '-api')?.value || '';
        const token = document.getElementById(service + '-token')?.value || '';
        const badge = document.getElementById(service + '-status');

        badge.textContent = 'Testing...';
        badge.className = 'integration-badge testing';

        fetch('/api/test-connection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ service, url, api_key: apiKey, token })
        })
        .then(r => r.json())
        .then(data => {
            if (data.connected) {
                badge.textContent = 'Connected' + (data.version ? ' (v' + data.version + ')' : '');
                badge.className = 'integration-badge connected';
            } else {
                badge.textContent = 'Failed';
                badge.className = 'integration-badge error';
            }
        })
        .catch(err => {
            badge.textContent = 'Error';
            badge.className = 'integration-badge error';
        });
    }

    // Version check
    function checkForUpdates(showToastOnNoUpdate = false) {
        const checkBtn = document.getElementById('btn-check-updates');
        const dotEl = document.getElementById('settings-version-dot');
        checkBtn.disabled = true;
        checkBtn.textContent = 'Checking...';

        fetch('/api/version')
            .then(r => r.json())
            .then(data => {
                document.getElementById('current-version').textContent = 'v' + data.current_version;

                // Store check time and result for dashboard
                const now = new Date();
                localStorage.setItem('ripforge_last_update_check', now.toISOString());
                localStorage.setItem('ripforge_update_available', data.update_available ? 'true' : 'false');
                localStorage.setItem('ripforge_latest_version', data.latest_version || '');
                document.getElementById('last-check-time').textContent = now.toLocaleString();

                if (data.error) {
                    dotEl.className = 'version-dot unknown';
                    dotEl.title = 'Unable to check for updates';
                    if (showToastOnNoUpdate) showToast('Unable to check for updates', 'error');
                } else if (data.update_available) {
                    dotEl.className = 'version-dot update-available';
                    dotEl.title = 'Update available: v' + data.latest_version;
                    document.getElementById('latest-version-row').style.display = 'flex';
                    document.getElementById('latest-version').textContent = 'v' + data.latest_version;
                    document.getElementById('btn-settings-update').style.display = 'inline-block';
                    showToast('Update available: v' + data.latest_version, 'success');
                } else {
                    dotEl.className = 'version-dot up-to-date';
                    dotEl.title = 'Up to date';
                    document.getElementById('latest-version-row').style.display = 'none';
                    document.getElementById('btn-settings-update').style.display = 'none';
                    if (showToastOnNoUpdate) showToast('You are running the latest version', 'success');
                }
            })
            .catch(err => {
                console.error('Error checking version:', err);
                if (showToastOnNoUpdate) showToast('Error checking for updates', 'error');
            })
            .finally(() => {
                checkBtn.disabled = false;
                checkBtn.textContent = 'Check Now';
            });
    }

    // Install update
    function performUpdate() {
        const updateBtn = document.getElementById('btn-settings-update');
        updateBtn.disabled = true;
        updateBtn.textContent = 'Updating...';

        fetch('/api/update', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Clear update cache so stale versions don't show after update
                    localStorage.removeItem('ripforge_update_available');
                    localStorage.removeItem('ripforge_latest_version');
                    localStorage.removeItem('ripforge_last_update_check');
                    showToast('Update installed!', 'success');
                    countdownReload(updateBtn, 5);
                } else {
                    showToast('Update failed: ' + (data.error || 'Unknown error'), 'error');
                    updateBtn.disabled = false;
                    updateBtn.textContent = 'Install Update';
                }
            })
            .catch(err => {
                // Connection lost likely means service restarted
                countdownReload(updateBtn, 5);
            });
    }

    function countdownReload(btn, seconds) {
        let remaining = seconds;
        btn.textContent = `Restarting ${remaining}...`;
        const interval = setInterval(() => {
            remaining--;
            if (remaining > 0) {
                btn.textContent = `Restarting ${remaining}...`;
            } else {
                clearInterval(interval);
                btn.textContent = 'Reloading...';
                window.location.reload();
            }
        }, 1000);
    }

    // Simple semver comparison: returns true if v1 > v2
    function isNewerVersion(v1, v2) {
        if (!v1 || !v2) return false;
        const p1 = v1.replace(/^v/, '').split('.').map(Number);
        const p2 = v2.replace(/^v/, '').split('.').map(Number);
        for (let i = 0; i < Math.max(p1.length, p2.length); i++) {
            const a = p1[i] || 0, b = p2[i] || 0;
            if (a > b) return true;
            if (a < b) return false;
        }
        return false;
    }

    // Load cached data on page load (no API call)
    function loadCachedVersion() {
        const lastCheck = localStorage.getItem('ripforge_last_update_check');
        const cachedUpdate = localStorage.getItem('ripforge_update_available');
        const cachedLatest = localStorage.getItem('ripforge_latest_version');
        const dotEl = document.getElementById('settings-version-dot');

        if (lastCheck) {
            document.getElementById('last-check-time').textContent = new Date(lastCheck).toLocaleString();
        }

        // Get current version from a quick API call (no GitHub check)
        fetch('/api/version')
            .then(r => r.json())
            .then(data => {
                document.getElementById('current-version').textContent = 'v' + data.current_version;

                // Use cached update status, but verify cached version is actually NEWER
                const updateAvailable = cachedUpdate === 'true' && cachedLatest && isNewerVersion(cachedLatest, data.current_version);

                if (updateAvailable) {
                    dotEl.className = 'version-dot update-available';
                    dotEl.title = 'Update available: v' + cachedLatest;
                    document.getElementById('latest-version-row').style.display = 'flex';
                    document.getElementById('latest-version').textContent = 'v' + cachedLatest;
                    document.getElementById('btn-settings-update').style.display = 'inline-block';
                } else {
                    dotEl.className = 'version-dot up-to-date';
                    dotEl.title = 'Up to date';
                    document.getElementById('latest-version-row').style.display = 'none';
                    document.getElementById('btn-settings-update').style.display = 'none';
                    // Clear stale cache
                    if (cachedUpdate === 'true' && cachedLatest && !isNewerVersion(cachedLatest, data.current_version)) {
                        localStorage.removeItem('ripforge_update_available');
                        localStorage.removeItem('ripforge_latest_version');
                    }
                }
            });
    }

    loadCachedVersion();

    // Load OS info for cheatsheet
    fetch("/api/hardware")
        .then(r => r.json())
        .then(data => {
            const osBadge = document.getElementById("os-badge");
            if (osBadge && data.os) {
                osBadge.textContent = data.os;
            } else if (osBadge) {
                osBadge.textContent = "Linux";
            }
        })
        .catch(() => {
            const osBadge = document.getElementById("os-badge");
            if (osBadge) osBadge.textContent = "Linux";
        });

    // Button handlers
    document.getElementById('btn-check-updates').addEventListener('click', () => checkForUpdates(true));
    document.getElementById('btn-settings-update').addEventListener('click', performUpdate);

    // Rip mode selector
    function updateRipModeInfo() {
        const mode = document.getElementById('rip-mode').value;
        document.querySelectorAll('.mode-details').forEach(el => el.style.display = 'none');
        document.getElementById('mode-' + mode).style.display = 'block';
    }
    document.getElementById('rip-mode').addEventListener('change', updateRipModeInfo);
    updateRipModeInfo(); // Set initial state

    // Save settings
    document.getElementById('btn-save').addEventListener('click', function() {
        const settings = {
            integrations: {
                radarr: {
                    enabled: document.getElementById('radarr-enabled').checked,
                    url: document.getElementById('radarr-url').value,
                    api_key: document.getElementById('radarr-api').value
                },
                sonarr: {
                    enabled: document.getElementById('sonarr-enabled').checked,
                    url: document.getElementById('sonarr-url').value,
                    api_key: document.getElementById('sonarr-api').value
                },
                overseerr: {
                    enabled: document.getElementById('overseerr-enabled').checked,
                    url: document.getElementById('overseerr-url').value,
                    api_key: document.getElementById('overseerr-api').value
                },
                plex: {
                    enabled: document.getElementById('plex-enabled').checked,
                    url: document.getElementById('plex-url').value,
                    token: document.getElementById('plex-token').value
                },
                tautulli: {
                    enabled: document.getElementById('tautulli-enabled').checked,
                    url: document.getElementById('tautulli-url').value,
                    api_key: document.getElementById('tautulli-api').value
                }
            },
            ripping: {
                min_length: parseInt(document.getElementById('min-length').value),
                main_feature_only: document.getElementById('main-feature-only').checked,
                skip_transcode: document.getElementById('skip-transcode').checked,
                rip_mode: document.getElementById('rip-mode').value,
                preferred_language: document.getElementById('preferred-language').value,
                keep_commentary: document.getElementById('keep-commentary').checked,
                auto_scan_on_insert: document.getElementById('auto-scan-on-insert').checked,
                auto_rip: document.getElementById('auto-rip').checked,
                auto_rip_delay: parseInt(document.getElementById('auto-rip-delay').value),
                confidence_threshold: parseInt(document.getElementById('confidence-threshold').value),
                notify_uncertain: document.getElementById('notify-uncertain').checked,
                eject_when_done: document.getElementById('eject-when-done').checked,
                debug_logging: document.getElementById('debug-logging').checked
            },
            paths: {
                raw_rips: document.getElementById('path-raw').value,
                movies: document.getElementById('path-movies').value,
                tv: document.getElementById('path-tv').value
            },
            community_db: {
                enabled: document.getElementById('community-db-enabled').checked
            }
        };

        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Settings saved!', 'success');
            }
        })
        .catch(err => {
            showToast('Error saving settings', 'error');
        });
    });
</script>
{% endblock %}
